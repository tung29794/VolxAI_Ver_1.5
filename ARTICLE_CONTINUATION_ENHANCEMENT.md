# C·∫£i ti·∫øn Logic Continuation cho AI Vi·∫øt b√†i

## V·∫•n ƒë·ªÅ

Khi vi·∫øt b√†i d√†i theo outline, AI th∆∞·ªùng d·ª´ng gi·ªØa ch·ª´ng (vi·∫øt ƒë∆∞·ª£c 1/2 outline) v√¨:
- ƒê·∫°t gi·ªõi h·∫°n max_tokens c·ªßa API
- Logic continuation c≈© ch·ªâ th·ª≠ 3 l·∫ßn (maxAttempts = 3)
- Kh√¥ng ki·ªÉm tra xem ƒë√£ vi·∫øt h·∫øt outline ch∆∞a

## Gi·∫£i ph√°p

### 1. TƒÉng s·ªë l·∫ßn ti·∫øp t·ª•c
```typescript
const maxAttempts = 10; // TƒÉng t·ª´ 3 l√™n 10
```

### 2. Th√™m function ki·ªÉm tra ho√†n th√†nh outline
```typescript
const checkOutlineCompletion = (content: string, outline: string): boolean => {
  if (!outline) return true; // No outline to check
  
  // Extract all [h2] headings from outline
  const outlineH2s = (outline.match(/\[h2\][^\n]+/gi) || [])
    .map(h => h.replace(/\[h2\]\s*/i, '').trim().toLowerCase());
  
  // Extract all <h2> headings from content
  const contentH2s = (content.match(/<h2[^>]*>([^<]+)<\/h2>/gi) || [])
    .map(h => h.replace(/<\/?h2[^>]*>/gi, '').trim().toLowerCase());
  
  console.log(`üìä Outline check: ${contentH2s.length}/${outlineH2s.length} H2 sections completed`);
  
  // Check if all outline H2s are present in content
  const missingCount = outlineH2s.filter(oh2 => 
    !contentH2s.some(ch2 => ch2.includes(oh2) || oh2.includes(ch2))
  ).length;
  
  if (missingCount > 0) {
    console.log(`‚ö†Ô∏è ${missingCount} sections still missing from outline`);
    return false;
  }
  
  console.log(`‚úÖ All outline sections completed`);
  return true;
};
```

### 3. Logic continuation th√¥ng minh h∆°n

**Tr∆∞·ªõc ƒë√¢y:**
```typescript
while (finishReason === "length" && attemptCount < maxAttempts) {
  attemptCount++;
  const continuationPrompt = `Continue writing the article from where it stopped...`;
  // ... call API
}
```

**B√¢y gi·ªù:**
```typescript
const outlineToCheck = customOutline || autoGeneratedOutline || "";

while (finishReason === "length" && attemptCount < maxAttempts) {
  // ‚úÖ Check if outline is complete before continuing
  if (outlineToCheck && checkOutlineCompletion(content, outlineToCheck)) {
    console.log(`‚úÖ Article outline is complete, stopping continuation`);
    break;
  }
  
  attemptCount++;
  console.log(`üìù Article was cut off, continuing... (Attempt ${attemptCount}/${maxAttempts})`);

  // ‚úÖ Build smarter continuation prompt
  let continuationPrompt = `Continue writing the article from where it stopped. `;
  
  if (outlineToCheck) {
    continuationPrompt += `Make sure to complete ALL sections from the outline:\n\n${outlineToCheck}\n\nContinue writing the remaining sections that haven't been covered yet. `;
  }
  
  continuationPrompt += `Write detailed content with ${lengthConfig.h2Paragraphs} paragraphs per H2 section and ${lengthConfig.h3Paragraphs} paragraphs per H3 subsection. Make sure to reach the total length of ${lengthConfig.minWords}-${lengthConfig.maxWords} words. Continue seamlessly from the previous content without repeating what was already written.`;

  // ... call API with enhanced prompt
}
```

### 4. TƒÉng max_tokens cho continuation
```typescript
body: JSON.stringify({
  model: model === "GPT 5" ? "gpt-4-turbo" : "gpt-3.5-turbo",
  messages: continuationMessages,
  temperature: 0.7,
  max_tokens: 4096, // TƒÉng t·ª´ 3500 l√™n 4096
}),
```

### 5. Logging chi ti·∫øt h∆°n
```typescript
console.log(`üìä Outline check: ${contentH2s.length}/${outlineH2s.length} H2 sections completed`);
console.log(`‚ö†Ô∏è ${missingCount} sections still missing from outline`);
console.log(`üìä Article length after continuation: ~${content.length / 4} words`);
console.log(`‚ö†Ô∏è No continuation text received, stopping`);
console.log(`‚ö†Ô∏è Reached maximum continuation attempts (${maxAttempts}), stopping`);
```

## C√°ch ho·∫°t ƒë·ªông

1. **AI vi·∫øt l·∫ßn ƒë·∫ßu** - G·ªçi API v·ªõi outline ƒë·∫ßy ƒë·ªß
2. **Ki·ªÉm tra finish_reason** - N·∫øu = "length" ‚Üí b√†i b·ªã c·∫Øt
3. **Ki·ªÉm tra outline completion** - So s√°nh s·ªë l∆∞·ª£ng H2 trong content vs outline
4. **N·∫øu ch∆∞a ƒë·ªß** - G·ªçi API ti·∫øp v·ªõi continuation prompt c√≥ outline ƒë·∫ßy ƒë·ªß
5. **Append n·ªôi dung m·ªõi** - N·ªëi ti·∫øp v√†o content c≈©
6. **L·∫∑p l·∫°i** - Cho ƒë·∫øn khi:
   - ‚úÖ Vi·∫øt h·∫øt outline (checkOutlineCompletion = true)
   - ‚úÖ finish_reason != "length" (AI t·ª± k·∫øt th√∫c)
   - ‚ö†Ô∏è ƒê·∫°t maxAttempts = 10

## V√≠ d·ª• Log khi ch·∫°y

```
üìù Article was cut off, continuing... (Attempt 2/10)
üìä Outline check: 3/7 H2 sections completed
‚ö†Ô∏è 4 sections still missing from outline
üìä Article length after continuation: ~1500 words

üìù Article was cut off, continuing... (Attempt 3/10)
üìä Outline check: 5/7 H2 sections completed
‚ö†Ô∏è 2 sections still missing from outline
üìä Article length after continuation: ~2200 words

üìù Article was cut off, continuing... (Attempt 4/10)
üìä Outline check: 7/7 H2 sections completed
‚úÖ All outline sections completed
‚úÖ Article outline is complete, stopping continuation
```

## L·ª£i √≠ch

1. **‚úÖ Vi·∫øt h·∫øt outline** - Kh√¥ng c√≤n b·ªã thi·∫øu ph·∫ßn cu·ªëi
2. **‚úÖ B√†i d√†i h∆°n** - C√≥ th·ªÉ vi·∫øt 3000-4000 t·ª´ kh√¥ng v·∫•n ƒë·ªÅ
3. **‚úÖ Th√¥ng minh h∆°n** - D·ª´ng khi ho√†n th√†nh outline (kh√¥ng l√£ng ph√≠ API calls)
4. **‚úÖ D·ªÖ debug** - Logging chi ti·∫øt gi√∫p theo d√µi qu√° tr√¨nh
5. **‚úÖ An to√†n** - V·∫´n c√≥ gi·ªõi h·∫°n maxAttempts = 10 ƒë·ªÉ tr√°nh v√≤ng l·∫∑p v√¥ h·∫°n

## File thay ƒë·ªïi

- `server/routes/ai.ts` - Handler `handleGenerateArticle`

## Testing

Test v·ªõi c√°c tr∆∞·ªùng h·ª£p:
1. ‚úÖ Outline ng·∫Øn (3-4 H2) - Ho√†n th√†nh trong 1-2 l·∫ßn
2. ‚úÖ Outline d√†i (7-10 H2) - C·∫ßn 3-5 l·∫ßn continuation
3. ‚úÖ B√†i vi·∫øt d√†i (3000+ words) - Continuation cho ƒë·∫øn khi ƒë·ªß
4. ‚úÖ Check log console ƒë·ªÉ x√°c nh·∫≠n logic ho·∫°t ƒë·ªông ƒë√∫ng

## Build Status

‚úÖ Build th√†nh c√¥ng kh√¥ng c√≥ l·ªói
- Client build: ‚úì
- Server build: ‚úì

## Deployment

Sau khi test th√†nh c√¥ng:
1. Upload `dist/server/node-build.mjs` l√™n server
2. Restart Node.js application
3. Monitor logs ƒë·ªÉ x√°c nh·∫≠n continuation ho·∫°t ƒë·ªông t·ªët
