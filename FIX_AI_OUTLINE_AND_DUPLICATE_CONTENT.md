# Fix: AI Outline Error & Duplicate Content

## Váº¥n Ä‘á»

### Issue 1: AI Outline â†’ Lá»—i 500 (Server Error)
Khi user chá»n "AI Outline" vÃ  click "Viáº¿t bÃ i", server tráº£ vá» lá»—i 500.

**Root Cause:**
- Frontend gá»­i `outlineType: "ai-outline"` nhÆ°ng `customOutline: ""`
- Backend chá»‰ generate outline cho `outlineType === "no-outline"`
- Vá»›i "ai-outline", backend khÃ´ng generate outline â†’ khÃ´ng cÃ³ outline structure â†’ AI viáº¿t khÃ´ng Ä‘Ãºng format â†’ error

**Expected Flow:**
1. User chá»n "AI Outline"
2. User click "Táº¡o outline" â†’ Frontend gá»i API generate outline
3. Frontend fill outline vÃ o `customOutline` field
4. User click "Viáº¿t bÃ i" â†’ Backend nháº­n customOutline vÃ  viáº¿t theo Ä‘Ã³

**Actual Bug:**
- Náº¿u user click "Viáº¿t bÃ i" TRÆ¯á»šC KHI click "Táº¡o outline"
- Backend nháº­n `outlineType: "ai-outline"` nhÆ°ng `customOutline: ""`
- Backend khÃ´ng generate outline â†’ fail

### Issue 2: No Outline â†’ Ná»™i dung bá»‹ láº·p láº¡i
Khi dÃ¹ng "No Outline", content bá»‹ duplicate sections:
- "Giá»›i thiá»‡u vá» chá»‰ bÃ¡o RSI" xuáº¥t hiá»‡n 2 láº§n
- "Äá»‹nh nghÄ©a cá»§a chá»‰ bÃ¡o RSI" láº·p láº¡i
- CÃ¡c sections bá»‹ write láº¡i trong continuation

**Root Cause:**
- Continuation prompt khÃ´ng Ä‘á»§ rÃµ rÃ ng vá» viá»‡c "DO NOT repeat"
- AI khÃ´ng biáº¿t chÃ­nh xÃ¡c sections nÃ o Ä‘Ã£ viáº¿t
- Thiáº¿u explicit warning vá» duplication

## Giáº£i phÃ¡p

### Fix 1: Generate Outline cho cáº£ "ai-outline" vÃ  "no-outline"

**TRÆ¯á»šC:**
```typescript
if (outlineType === "no-outline") {
  // Only generate for "no-outline"
  console.log("ğŸ“ Auto-generating outline for 'no-outline' option...");
  // ...
}
```

**SAU:**
```typescript
// Generate outline for BOTH "no-outline" and "ai-outline" when customOutline is empty
if ((outlineType === "no-outline" || outlineType === "ai-outline") && (!customOutline || !customOutline.trim())) {
  console.log(`ğŸ“ Auto-generating outline for '${outlineType}' option...`);
  // ... same outline generation logic
}
```

**Lá»£i Ã­ch:**
- âœ… "ai-outline" without customOutline â†’ auto-generate outline (backup)
- âœ… "no-outline" â†’ auto-generate outline nhÆ° cÅ©
- âœ… "ai-outline" with customOutline â†’ use customOutline
- âœ… KhÃ´ng cÃ²n error 500 khi user quÃªn click "Táº¡o outline"

### Fix 2: Improved Outline Handling Logic

**TRÆ¯á»šC:**
```typescript
if (customOutline && customOutline.trim()) {
  // Use custom outline
} else if (autoGeneratedOutline) {
  // Use auto-generated outline
} else if (outlineType === "ai-outline" || outlineType === "your-outline") {
  // Fallback: generic instruction
  userPrompt += `\nPlease structure the article...`;
}
```

**SAU:**
```typescript
if (customOutline && customOutline.trim()) {
  console.log(`ğŸ“‹ Using custom outline (${outlineType})`);
  // Add outline to prompt with EXACT structure requirement
} else if (autoGeneratedOutline) {
  console.log(`ğŸ“‹ Using auto-generated outline (${outlineType})`);
  // Add auto-generated outline to prompt
} else {
  // Should not happen in practice (all cases covered above)
  console.log(`âš ï¸ No outline available for ${outlineType}, AI will create structure`);
  userPrompt += `\nPlease structure the article...`;
}
```

**Lá»£i Ã­ch:**
- âœ… Clear logging vá» loáº¡i outline Ä‘ang dÃ¹ng
- âœ… Better error visibility náº¿u khÃ´ng cÃ³ outline
- âœ… Explicit handling cho má»i trÆ°á»ng há»£p

### Fix 3: Anti-Duplication Continuation Prompt

**TRÆ¯á»šC:**
```typescript
if (missingSections.length > 0) {
  continuationPrompt = `You must continue writing the article. The following sections are MISSING:
- Section 1
- Section 2
...
Write the missing sections. DO NOT repeat content.`;
}
```

**SAU:**
```typescript
if (missingSections.length > 0) {
  console.log(`ğŸ“‹ Missing sections: ${missingSections.join(', ')}`);
  continuationPrompt = `CRITICAL INSTRUCTION - Continue writing the article:

MISSING SECTIONS (YOU MUST WRITE THESE):
${missingSections.map(s => `- ${s}`).join('\n')}

FULL OUTLINE FOR REFERENCE:
${outlineToCheck}

IMPORTANT RULES:
1. Write ONLY the missing sections listed above
2. DO NOT repeat any content that was already written
3. DO NOT rewrite sections that are already complete
4. Continue seamlessly from where the article stopped
5. Each H2 section: ${lengthConfig.h2Paragraphs} detailed paragraphs
6. Each H3 subsection: ${lengthConfig.h3Paragraphs} paragraphs
7. Use proper HTML structure with line breaks

Start writing the missing sections now:`;
}
```

**Cáº£i tiáº¿n:**
- âœ… **CRITICAL INSTRUCTION** header Ä‘á»ƒ emphasize
- âœ… Clear formatting vá»›i sections cÃ³ title
- âœ… **7 IMPORTANT RULES** thay vÃ¬ generic instruction
- âœ… Rule #1: "Write ONLY the missing sections" (most important)
- âœ… Rule #2-3: Explicit anti-duplication warnings
- âœ… Full outline included for context
- âœ… Structured requirements (paragraphs count, HTML format)

## Expected Behavior After Fix

### Scenario 1: User chá»n "AI Outline" vÃ  click "Viáº¿t bÃ i" trá»±c tiáº¿p
**Before:** âŒ Error 500
**After:** âœ… Auto-generate outline â†’ Write article successfully

**Logs:**
```
ğŸ“ Auto-generating outline for 'ai-outline' option...
âœ… Auto-generated outline successfully
ğŸ“‹ Using auto-generated outline (ai-outline) with 2 paragraphs per H2
âœ… Gemini response received, length: ~1200 words
âœ… Content format validated successfully
```

### Scenario 2: User chá»n "AI Outline", click "Táº¡o outline", rá»“i "Viáº¿t bÃ i"
**Before:** âœ… Works (has customOutline)
**After:** âœ… Still works (uses customOutline)

**Logs:**
```
ğŸ“‹ Using custom outline (ai-outline)
âœ… Gemini response received, length: ~1100 words
âœ… Content format validated successfully
```

### Scenario 3: User chá»n "No Outline"
**Before:** âš ï¸ Duplicate content in continuation
**After:** âœ… No duplication, clean continuation

**Logs:**
```
ğŸ“ Auto-generating outline for 'no-outline' option...
âœ… Auto-generated outline successfully
ğŸ“‹ Using auto-generated outline (no-outline)
âœ… Gemini response received, length: ~800 words
ğŸ“Š Outline check: 7/10 H2 sections completed
âš ï¸ Outline incomplete, forcing continuation
ğŸ“‹ Missing sections: Section 8, Section 9, Section 10
ğŸ“ Gemini continuation received: +500 words
âœ… All outline sections now complete!
âœ… Article generation completed in 2 attempt(s)
```

### Scenario 4: Continuation with duplicate prevention
**Before:**
```
<h2>Giá»›i thiá»‡u vá» chá»‰ bÃ¡o RSI</h2>
<p>Content...</p>

[Continuation]
<h2>Giá»›i thiá»‡u vá» chá»‰ bÃ¡o RSI</h2>  âŒ DUPLICATE!
<p>Same content again...</p>
```

**After:**
```
<h2>Giá»›i thiá»‡u vá» chá»‰ bÃ¡o RSI</h2>
<p>Content...</p>

[Continuation - Only missing sections]
<h2>CÃ´ng dá»¥ng cá»§a chá»‰ bÃ¡o RSI</h2>  âœ… NEW SECTION
<p>New content...</p>
```

## Code Changes Summary

| File | Function | Change | Line |
|------|----------|--------|------|
| server/routes/ai.ts | handleGenerateArticle | Outline generation condition | ~1271 |
| server/routes/ai.ts | handleGenerateArticle | Outline handling logic | ~1375-1405 |
| server/routes/ai.ts | handleGenerateArticle | Continuation prompt | ~1682-1700 |

## Testing Checklist

### Test Case 1: AI Outline without custom outline
- [ ] Select "AI Outline"
- [ ] DO NOT click "Táº¡o outline"
- [ ] Click "Viáº¿t bÃ i" immediately
- [ ] Expected: âœ… Article generated successfully (no error 500)
- [ ] Check logs: Should see "Auto-generating outline for 'ai-outline'"

### Test Case 2: AI Outline with custom outline
- [ ] Select "AI Outline"
- [ ] Click "Táº¡o outline" â†’ Wait for outline
- [ ] Click "Viáº¿t bÃ i"
- [ ] Expected: âœ… Article follows custom outline exactly
- [ ] Check logs: Should see "Using custom outline (ai-outline)"

### Test Case 3: No Outline (long article)
- [ ] Select "No Outline"
- [ ] Choose "Long" length (to trigger continuation)
- [ ] Enable "Tham kháº£o Google" (Gemini)
- [ ] Click "Viáº¿t bÃ i"
- [ ] Expected: âœ… No duplicate sections
- [ ] Check: Read through article, verify no repeated H2/H3
- [ ] Check logs: Should see "Missing sections: ..." (not repeated ones)

### Test Case 4: Continuation without duplication
- [ ] Generate any article that triggers continuation
- [ ] Check console logs for "Missing sections: Section X, Y, Z"
- [ ] Read continuation content
- [ ] Expected: âœ… Only new sections written, no repetition
- [ ] Check: H2 tags in content match outline exactly (no duplicates)

## Key Improvements

1. âœ… **AI Outline now works** - Auto-generate outline náº¿u customOutline empty
2. âœ… **No more error 500** - All outline types covered
3. âœ… **Duplicate prevention** - Strong anti-duplication rules in continuation
4. âœ… **Better logging** - Clear visibility vá» outline source
5. âœ… **Explicit instructions** - 7-point IMPORTANT RULES for continuation
6. âœ… **Consistent behavior** - "no-outline" and "ai-outline" both auto-generate

## Build Status

âœ… Build successful
- Client: âœ“ (940.10 kB)
- Server: âœ“ (225.18 kB)

## Deployment

Ready to deploy:
1. Upload `dist/server/node-build.mjs`
2. Restart Node.js application
3. Test all 4 test cases above
4. Monitor logs for duplicate detection

**Date:** January 9, 2026
**Status:** âœ… FIXED - AI Outline & Duplication
